name: å‘å¸ƒç‰ˆæœ¬

on:
  push:
    branches:
      - release-aio
      - test-release-aio
      # - release          # åŒ¹é…ä¸»å‘å¸ƒåˆ†æ”¯
      # - 'test-*'         # åŒ¹é…æ‰€æœ‰ test- å¼€å¤´çš„åˆ†æ”¯ï¼ˆé€šé…ç¬¦ï¼‰

jobs:
  # å…¬å…±æ­¥éª¤ï¼ˆæ‰€æœ‰åˆ†æ”¯éƒ½éœ€è¦æ‰§è¡Œçš„å‰ç½®æ“ä½œï¼‰
  common-steps:
    runs-on: ubuntu-latest
    outputs:
      modpack_name: ${{ steps.read-modpackname.outputs.value }}
      modpack_ver: ${{ steps.generate_modpack_version.outputs.VERSION }}
      mc_version: ${{ steps.read-minecraft.outputs.value }}
      forge_version: ${{ steps.read-forge.outputs.value }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # åªå–æœ€æ–°æäº¤ï¼ŒåŠ é€Ÿ
      - name: è¯»å–æ•´åˆåŒ…å
        uses: SebRollen/toml-action@v1.2.0
        id: read-modpackname
        with:
          file: ${{ github.workspace }}/pack.toml
          field: 'name'
      - name: è¯»å–æ•´åˆåŒ…ç‰ˆæœ¬å·
        uses: SebRollen/toml-action@v1.2.0
        id: read-version
        with:
          file: ${{ github.workspace }}/pack.toml
          field: 'version'
      - name: è¯»å–mcç‰ˆæœ¬å·
        uses: SebRollen/toml-action@v1.2.0
        id: read-minecraft
        with:
          file: ${{ github.workspace }}/pack.toml
          field: 'versions.minecraft'
      - name: è¯»å–forgeç‰ˆæœ¬å·
        uses: SebRollen/toml-action@v1.2.0
        id: read-forge
        with:
          file: ${{ github.workspace }}/pack.toml
          field: 'versions.forge'
      - name: ç”Ÿæˆæ•´åˆåŒ…å¸¦æµ‹è¯•åç¼€ç‰ˆæœ¬å·
        id: generate_modpack_version
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          if [[ "$BRANCH_NAME" == *test* ]]; then
            VERSION="${{ steps.read-version.outputs.value }}-test-build-${{ github.run_number }}"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          else
            VERSION="${{ steps.read-version.outputs.value }}"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi
      - name: è¾“å‡ºè¯»å–çš„å˜é‡ç”¨ä½œéªŒè¯
        run: |
          echo "Modpack Name: ${{ steps.read-modpackname.outputs.value }}"
          echo "Modpack Version: ${{ steps.read-version.outputs.value }}"
          echo "Version Suffix: ${{ steps.set_version_sufffix.outputs.VERSION_SUFFIX }}"
          echo "Modpack Full Version: ${{ steps.generate_modpack_version.outputs.VERSION }}"
          echo "Minecraft Version: ${{ steps.read-minecraft.outputs.value }}"
          echo "Forge Version: ${{ steps.read-forge.outputs.value }}"

  # å®¢æˆ·ç«¯ç›¸å…³ä»»åŠ¡ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
  # client-tasks:
  #   needs: common-steps       # ä¾èµ–å…¬å…±æ­¥éª¤å®Œæˆ
  #   runs-on: ubuntu-latest
  #   if: >                       # æ¡ä»¶åˆ¤æ–­ï¼šreleaseåˆ†æ”¯ æˆ– test-client-* åˆ†æ”¯è§¦å‘
  #     github.ref_name == 'release' || 
  #     startsWith(github.ref_name, 'test-client-')
  #   env:  # Job çº§ç¯å¢ƒå˜é‡ï¼ˆç®€åŒ–è¯»å–å˜é‡ï¼‰
  #     MODPACK_NAME: ${{ needs.common_steps.outputs.modpack_name }}
  #     MODPACK_VERSION: ${{ needs.common_steps.outputs.modpack_ver }}
  #     VERSION_SUFFIX: ${{ needs.common_steps.outputs.version_sufffix }}
  #     MC_VERSION: ${{ needs.common_steps.outputs.mc_version }}
  #     FORGE_VERSION: ${{ needs.common_steps.outputs.forge_version }}
  #   steps:
  #     - name: æ‰§è¡Œå®¢æˆ·ç«¯ä¸“å±æ“ä½œ
  #       run: |
  #         echo "ğŸ”§ æ‰§è¡Œå®¢æˆ·ç«¯æ„å»º/æµ‹è¯•ï¼ˆåˆ†æ”¯: ${{ github.ref_name }}ï¼‰"
  #         # å®é™…é¡¹ç›®ä¸­æ›¿æ¢ä¸ºå®¢æˆ·ç«¯ç›¸å…³å‘½ä»¤ï¼ˆå¦‚ npm run build:clientï¼‰

  # # æœåŠ¡ç«¯ç›¸å…³ä»»åŠ¡ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
  # server-tasks:
  #   needs: common-steps
  #   runs-on: ubuntu-latest
  #   if: >                       # æ¡ä»¶åˆ¤æ–­ï¼šreleaseåˆ†æ”¯ æˆ– test-server-* åˆ†æ”¯è§¦å‘
  #     github.ref_name == 'release' || 
  #     startsWith(github.ref_name, 'test-server-')
  #   steps:
  #     - name: æ‰§è¡ŒæœåŠ¡ç«¯ä¸“å±æ“ä½œ
  #       run: |
  #         echo "âš™ï¸ æ‰§è¡ŒæœåŠ¡ç«¯ç¼–è¯‘/é›†æˆæµ‹è¯•ï¼ˆåˆ†æ”¯: ${{ github.ref_name }}ï¼‰"
  #         # å®é™…é¡¹ç›®ä¸­æ›¿æ¢ä¸ºæœåŠ¡ç«¯ç›¸å…³å‘½ä»¤ï¼ˆå¦‚ mvn clean packageï¼‰

  # è¡¥ä¸ç›¸å…³ä»»åŠ¡ï¼Œä¾èµ–å®¢æˆ·ç«¯ç›¸å…³ä»»åŠ¡çš„manifest.json
  # patch-tasks:
  #   needs: client-tasks
  #   runs-on: ubuntu-latest
  #   if: >                       # æ¡ä»¶åˆ¤æ–­ï¼šreleaseåˆ†æ”¯ æˆ– test-patch-* åˆ†æ”¯è§¦å‘
  #     github.ref_name == 'release' || 
  #     startsWith(github.ref_name, 'test-patch-')
  #   steps:
  #     - name: æ£€å‡ºä»£ç 
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #         fetch-tags: true
      

