name: ÂèëÂ∏ÉÂÆ¢Êà∑Á´ØË°•‰∏Å
run-name: ${{ github.actor }} Ê≠£Âú®ÂèëÂ∏ÉÂÆ¢Êà∑Á´ØÊñ∞ÁâàÊú¨üöÄ
on:
  push:
    branches:
      - test-release
      - release

jobs:
  Release:
    runs-on: ubuntu-latest
    name: ÂèëÂ∏ÉüöÄ
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: ËØªÂèñÁâàÊú¨Âè∑
        uses: SebRollen/toml-action@v1.2.0
        id: read-version
        with:
          file: ${{ github.workspace }}/pack.toml
          field: 'version'
      - name: ÁîüÊàêÊï¥ÂêàÂåÖnightlyÊûÑÂª∫ÂêéÁºÄ
        id: set_version_prefix
        run: |
          echo ${{ steps.read-modpackname.outputs.value }}
          echo ${{ steps.read-version.outputs.value }}
          if [[ $GITHUB_REF == refs/heads/test-release ]]; then
            VERSION_SUFFIX=$(date +%m%d%H%M)
            echo "VERSION_SUFFIX=-$VERSION_SUFFIX" >> $GITHUB_OUTPUT
          else
            echo "VERSION_SUFFIX=" >> $GITHUB_OUTPUT
          fi
      - name: Ëé∑ÂèñÊúÄËøëÁöÑtagÂπ∂ÈÖçÁΩÆÁéØÂ¢ÉÂèòÈáè
        run: |
          latest_tag=$(git describe --tags --abbrev=0)
          echo "ÊúÄËøëÁöÑtagÊòØ: $latest_tag"
          echo "LATEST_TAG=$latest_tag" >> $GITHUB_ENV
      - name: Ê†πÊçÆtagÁîüÊàêË°•‰∏Å
        run: |
          # Ëé∑Âèñ‰ªéÊúÄËøëÁöÑtagÂà∞ÂΩìÂâçÊèê‰∫§ÁöÑÊâÄÊúâÂèòÂåñÊñá‰ª∂
          changed_files=$(git diff --name-only ${{ env.LATEST_TAG }} HEAD)
          echo "ÂèòÂåñÁöÑÊñá‰ª∂Êúâ: $changed_files"

          # ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁõÆÂΩïÂπ∂Â§çÂà∂ÂèòÂåñÁöÑÊñá‰ª∂
          temp_dir=$(mktemp -d)
          for file in $changed_files; do
              mkdir -p "$temp_dir/$(dirname $file)"
              cp "$file" "$temp_dir/$file"
          done

          # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáèÔºåÁî®‰∫éÂêéÁª≠‰∏ä‰º†Â∑•‰ª∂Êó∂ÊåáÂÆöË∑ØÂæÑ
          echo "PATCH_DIR=$temp_dir" >> $GITHUB_ENV
      - name: ‰∏ä‰º†Ë°•‰∏Å
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.LATEST_TAG }}-to-${{ steps.read-version.outputs.value }}${{ steps.set_version_prefix.outputs.VERSION_SUFFIX }}-patch
          path: ${{ env.PATCH_DIR }}
      - run: echo "üçè This job's status is ${{ job.status }}."
