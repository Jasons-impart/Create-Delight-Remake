name: 发布补丁

on:
  push:
    branches:
      - release
      - test-release  # 可以根据需要修改为你的目标分支

jobs:
  generate-patches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取全量历史记录

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1))
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
        shell: bash

      - name: Generate Linux patch script
        run: |
          git diff ${{ steps.prev_tag.outputs.prev_tag }} HEAD > linux_patch.diff
          cat << EOF > apply_linux_patch.sh
#!/bin/bash
git apply linux_patch.diff
EOF
          chmod +x apply_linux_patch.sh
        shell: bash

      - name: Generate Windows patch script
        run: |
          git diff ${{ steps.prev_tag.outputs.prev_tag }} HEAD > windows_patch.diff
          cat << EOF > apply_windows_patch.bat
@echo off
git apply windows_patch.diff
EOF
        shell: bash

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: patch-scripts
          path: |
            linux_patch.diff
            apply_linux_patch.sh
            windows_patch.diff
            apply_windows_patch.bat    
