name: 发布客户端补丁
run-name: ${{ github.actor }} 正在发布客户端补丁🚀
on:
  push:
    branches:
      - test-release
      - release

jobs:
  Release:
    runs-on: ubuntu-latest
    name: 发布🚀
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: 读取版本号
        uses: SebRollen/toml-action@v1.2.0
        id: read-version
        with:
          file: ${{ github.workspace }}/pack.toml
          field: 'version'
      - name: 生成整合包nightly构建后缀
        id: set_version_prefix
        run: |
          echo ${{ steps.read-modpackname.outputs.value }}
          echo ${{ steps.read-version.outputs.value }}
          if [[ $GITHUB_REF == refs/heads/test-release ]]; then
            VERSION_SUFFIX=$(date +%m%d%H%M)
            echo "VERSION_SUFFIX=-$VERSION_SUFFIX" >> $GITHUB_OUTPUT
          else
            echo "VERSION_SUFFIX=" >> $GITHUB_OUTPUT
          fi
      - name: 获取最近的tag并配置环境变量
        run: |
          latest_tag=$(git describe --tags --abbrev=0)
          echo "最近的tag是: $latest_tag"
          echo "LATEST_TAG=$latest_tag" >> $GITHUB_ENV
      - name: 根据tag生成补丁
        run: |
          # 获取从最近的tag到当前提交的所有变化文件
          changed_files=$(git diff --name-only ${{ env.LATEST_TAG }} HEAD)
          echo "变化的文件有: $changed_files"

          # 创建一个临时目录并复制变化的文件
          temp_dir=$(mktemp -d)
          for file in $changed_files; do
              if [ -e "$file" ]; then
                mkdir -p "$temp_dir/$(dirname $file)"
                cp -rL "$file" "$temp_dir/$file"
              else
                echo "文件 $file 已删除，跳过复制。"
              fi
          done

          # 设置环境变量，用于后续上传工件时指定路径
          echo "PATCH_DIR=$temp_dir" >> $GITHUB_ENV
      - name: 从生成的补丁临时目录里删除打包会忽略的文件
        run: |
            mapfile -t names < ${{ github.workspace }}/.packwizignore
            names+=("pack.toml")
            for filename in "${names[@]}"; do
              echo "Deleting files $filename"
              find ${{ env.PATCH_DIR }} -name "${filename}" -exec rm {} +
            done
      - name: 上传补丁
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.LATEST_TAG }}-to-${{ steps.read-version.outputs.value }}${{ steps.set_version_prefix.outputs.VERSION_SUFFIX }}-patch
          path: ${{ env.PATCH_DIR }}
      - run: echo "🍏 This job's status is ${{ job.status }}."
