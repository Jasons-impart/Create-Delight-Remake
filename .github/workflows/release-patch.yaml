name: å‘å¸ƒè¡¥ä¸
run-name: ${{ github.actor }} æ­£åœ¨å‘å¸ƒè¡¥ä¸ğŸš€
on:
  push:
    branches:
      - test-patch

jobs:
  Release:
    runs-on: ubuntu-latest
    name: å‘å¸ƒğŸš€
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: è¯»å–åŒ…å
        uses: SebRollen/toml-action@v1.2.0
        id: read-modpackname
        with:
          file: ${{ github.workspace }}/pack.toml
          field: 'name'
      - name: è¯»å–ç‰ˆæœ¬å·
        uses: SebRollen/toml-action@v1.2.0
        id: read-version
        with:
          file: ${{ github.workspace }}/pack.toml
          field: 'version'
      - name: è·å–æœ€è¿‘çš„tagå¹¶é…ç½®ç¯å¢ƒå˜é‡
        run: |
          # è·å–å½“å‰ commit çš„ hash
          current_commit=$(git rev-parse HEAD)
          # è·å–å½“å‰ commit å…³è”çš„ tag
          current_commit_tags=$(git tag --points-at $current_commit)
          if [ -z "$current_commit_tags" ]; then
            # å½“å‰ commit æ²¡æœ‰å…³è” tagï¼Œç›´æ¥å–æœ€æ–° tag
            latest_tag=$(git tag --sort=-creatordate | head -n 1)
          else
            # å½“å‰ commit æœ‰å…³è” tagï¼Œè¿‡æ»¤æ‰è¿™äº› tag åå–æœ€æ–° tag
            latest_tag=$(git tag --sort=-creatordate | grep -v "$current_commit_tags" | head -n 1)
          fi
          if [ -z "$latest_tag" ]; then
            echo "No suitable tag found. Exiting."
            exit 1
          fi
          echo "æœ€è¿‘çš„tagæ˜¯: $latest_tag"
          echo "LATEST_TAG=$latest_tag" >> $GITHUB_ENV
      - name: Prepare patch files
        run: |
          # ç”Ÿæˆå®Œæ•´å·®å¼‚æŠ¥å‘Š
          git diff --name-status ${{ env.LATEST_TAG }} HEAD > diff_report.txt
          
          # è§£æå·®å¼‚æŠ¥å‘Š
          grep -E '^D' diff_report.txt | cut -f2 > deleted_files.txt
          grep -E '^R' diff_report.txt | cut -f2 >> deleted_files.txt
          grep -E '^[A|M]' diff_report.txt | cut -f2 > added_files.txt
          grep -E '^R' diff_report.txt | cut -f3 >> added_files.txt
          grep -E '^C' diff_report.txt | cut -f3 >> added_files.txt

          # åˆ›å»ºè¡¥ä¸ç›®å½•
          mkdir -p patch

          # å¤åˆ¶æ–°å¢/ä¿®æ”¹æ–‡ä»¶
          while IFS= read -r file; do
            mkdir -p "patch/$(dirname "$file")"
            cp "$file" "patch/$file"
          done < added_files.txt

      - name: Create Linux script
        run: |
          cat << 'EOF' > deploy-linux.sh
          #!/bin/bash
          echo "æ­£åœ¨åº”ç”¨è¡¥ä¸..."
          BASE_DIR=$(dirname "$(readlink -f "$0")")
          
          # å¤„ç†åˆ é™¤
          if [ -f "$BASE_DIR/deleted_files.txt" ]; then
            echo "æ­£åœ¨å¤„ç†åˆ é™¤/é‡å‘½åæ–‡ä»¶..."
            while IFS= read -r line; do
              if [ -f "$file" ]; then
                rm -v "$file" || echo "æ— æ³•åˆ é™¤ $file"
              fi
            done < "$BASE_DIR/deleted_files.txt"
          fi

          # å¤„ç†æ–‡ä»¶æ›´æ–°/æ–°å¢
          while IFS= read -r file; do
            target_dir=$(dirname "$file")
            mkdir -p "$target_dir"
            mv -v "$BASE_DIR/patch/$file" "$file" || echo "æ— æ³•å¤åˆ¶ $file"
          done < "$BASE_DIR/added_files.txt"

          echo -e "\næ“ä½œå®Œæˆï¼"
          EOF

      - name: Create Windows script
        run: |
          cat << 'EOF' > deploy-windows.bat
          @echo off
          setlocal enabledelayedexpansion
          echo æ­£åœ¨åº”ç”¨è¡¥ä¸...
          set "BASE_DIR=%~dp0"
          
          REM å¤„ç†æ–‡ä»¶åˆ é™¤
          if exist "%BASE_DIR%deleted_files.txt" (
            echo æ­£åœ¨æ¸…ç†å·²åˆ é™¤æ–‡ä»¶...
            for /f "delims=" %%f in (%BASE_DIR%deleted_files.txt) do (
              set "file=%%f"
              if exist "!file!" (
                del /f /q "!file!" >nul && echo å·²åˆ é™¤: !file!
              )
            )
          )

          REM å¤„ç†æ–‡ä»¶æ›´æ–°/æ–°å¢
          for /f "delims=" %%f in (%BASE_DIR%added_files.txt) do (
            set "file=%%f"
            set "target_dir=!file:\=/!"
            for %%d in ("!target_dir!") do set "target_dir=%%~pd"
            mkdir "!target_dir!" >nul 2>&1
            if exist "%BASE_DIR%patch\!file!" (
              move /y "%BASE_DIR%patch\!file!" "!file!" >nul && echo å·²å¤åˆ¶: !file!
            ) else (
              echo æ–‡ä»¶ä¸å­˜åœ¨: !file!
            )
          )
          
          echo æ“ä½œå®Œæˆï¼
          EOF

      - name: Archive artifacts
        run: |
          zip -r patch.zip \
            added_files.txt \
            deleted_files.txt \
            deploy-linux.sh \
            deploy-windows.bat \
            patch/

      - name: ä¸Šä¼ è¡¥ä¸
        uses: actions/upload-artifact@v4
        with:
          name: "[Patch]-${{ env.LATEST_TAG }}-to-${{ steps.read-version.outputs.value }}"
          path: patch
      - run: echo "ğŸ This job's status is ${{ job.status }}."
